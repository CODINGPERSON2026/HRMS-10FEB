  <!-- ==================== STATISTICS MODAL (prjStatsModal) ==================== -->
  <div class="modal fade" id="prjStatsModal" tabindex="-1" aria-labelledby="prjStatsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content border-0 shadow-lg" style="border-radius: 16px; overflow: hidden;">
        
        <!-- Header -->
        <div class="modal-header text-white" 
             style="background: linear-gradient(135deg, #0d6efd, #6610f2); padding: 1.5rem 2rem;">
          <h5 class="modal-title fw-bold mb-0" id="prjStatsModalLabel">
            <i class="fas fa-chart-bar me-2"></i>
            Project Cost Statistics
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
  
        <!-- Body -->
        <div class="modal-body p-4" style="min-height: 520px; background: #f8f9fa;">
          <div class="d-flex flex-column h-100">
            <div class="mb-4">
              <h6 class="fw-semibold text-secondary mb-1">Overview</h6>
              <p class="text-muted small mb-0">
                Total <strong>project_cost</strong> grouped by project head
              </p>
            </div>
  
            <!-- Chart container -->
            <div style="flex: 1; position: relative; min-height: 380px;">
              <canvas id="statsCostByHeadChart"></canvas>
            </div>
  
            <!-- Footer note -->
            <div class="mt-4 text-center small text-muted">
              Data is aggregated from the <code>projects</code> table • Last updated: real-time
            </div>
          </div>
        </div>
  
        <!-- Footer -->
        <div class="modal-footer bg-light border-0">
          <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">
            Close
          </button>
          <button type="button" class="btn btn-primary px-4" onclick="refreshStatsChart()">
            <i class="fas fa-sync-alt me-1"></i> Refresh
          </button>
        </div>
      </div>
    </div>
  </div>
<!-- Chart.js v4 (latest stable as of 2025) -->

  <script>

    async function loadStatisticsChart() {
        const canvas = document.getElementById('statsCostByHeadChart');
        
        if (!canvas) {
            console.warn("Canvas #statsCostByHeadChart not found");
            return;
        }
    
        // Remember the parent once — before any DOM changes
        const container = canvas.parentElement;
        if (!container) {
            console.warn("Canvas has no parent container");
            return;
        }
    
        // Show loading inside the container (without removing canvas yet)
        container.innerHTML = `
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>`;
    
        try {
            const response = await fetch('/projects/stats/cost_by_head');
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
    
            const result = await response.json();
    
            // Clear loading state
            container.innerHTML = '';
    
            // Put canvas back (important!)
            container.appendChild(canvas);
            canvas.style.display = 'block';
    
            // Handle no data
            if (result.status !== 'success' || !Array.isArray(result.data) || result.data.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info text-center py-5 m-0">
                        <i class="fas fa-info-circle me-2"></i>
                        No cost data available yet
                    </div>`;
                return;
            }
    
            const data = result.data;
            const labels = data.map(item => item.head || 'Unassigned');
            const values = data.map(item => Number(item.total_cost) || 0);
    
            // Destroy old chart safely
            if (window.statsChart instanceof Chart) {
                window.statsChart.destroy();
                window.statsChart = null;
            }
    
            // Create new chart
            window.statsChart = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Total Cost (₹)',
                        data: values,
                        backgroundColor: 'rgba(54, 162, 235, 0.65)',
                        borderColor: 'rgba(54, 162, 235, 0.9)',
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => {
                                    const val = ctx.raw;
                                    const cnt = data[ctx.dataIndex]?.count || 0;
                                    return ` ₹ ${Number(val).toLocaleString('en-IN')}  (${cnt} project${cnt !== 1 ? 's' : ''})`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { grid: { display: false } },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: v => '₹ ' + Number(v).toLocaleString('en-IN', { notation: 'compact' })
                            }
                        }
                    }
                }
            });
    
        } catch (err) {
            console.error('Chart load error:', err);
            
            // Show error in container (canvas already removed)
            container.innerHTML = `
                <div class="alert alert-danger text-center py-5 m-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Failed to load chart<br>
                    <small>${err.message || 'Network/server error'}</small>
                </div>`;
        }
    }// Statistics modal & chart
let statsChart = null;

function openStatisticsModal() {
    // 1. Get references to both modals
    const dashboardModalEl = document.getElementById('projDash_modal');
    const statsModalEl     = document.getElementById('prjStatsModal');

    const dashboardModal = bootstrap.Modal.getInstance(dashboardModalEl) || 
                           new bootstrap.Modal(dashboardModalEl);

    const statsModal = new bootstrap.Modal(statsModalEl);

    // 2. When stats modal is about to show → hide dashboard
    statsModalEl.addEventListener('show.bs.modal', function onShow() {
        dashboardModal.hide();
    }, { once: true });   // only needed once per open

    // 3. When stats modal is fully hidden → re-show dashboard
    statsModalEl.addEventListener('hidden.bs.modal', function onHidden() {
        dashboardModal.show();
        
        // Optional: clean up the one-time listener if you want
        // (not strictly necessary since we use {once: true} above)
        statsModalEl.removeEventListener('show.bs.modal', onShow);
    }, { once: true });

    // 4. Finally show the stats modal
    statsModal.show();

    // 5. Load chart shortly after it's visible
    setTimeout(loadStatisticsChart, 350);
}


  </script>