<style>
  .message {
    margin-bottom: 8px;
    padding: 8px 12px;
    border-radius: 14px;
    max-width: 70%;
    font-size: 14px;
    line-height: 1.4;
    word-wrap: break-word;
    animation: fadeIn 0.2s ease-in-out;
  }
  
  .user-msg {
    background: linear-gradient(135deg, #0d6efd, #2d8cff);
    color: white;
    margin-left: auto;
    text-align: right;
  }
  
  .bot-msg {
    background: white;
    border: 1px solid #e0e0e0;
    margin-right: auto;
  }
  
  #chatArea {
    scroll-behavior: smooth;
  }
  
  /* üî• Model Upgrade Notice */
  .model-upgrade {
    background: linear-gradient(135deg, #fff3cd, #ffeeba);
    border: 1px solid #ffc107;
    font-size: 12px;
    color: #850404;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }
  </style>
  
  
  <!-- AI MODAL -->
  <div class="modal fade" id="AIMODAL" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
  
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">
            UMS AI Assistant 
            <span style="font-size:12px; opacity:0.8;">(Llama 1B)</span>
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
  
        <div class="modal-body p-0">
  
          <!-- CHAT AREA -->
          <div id="chatArea" style="height:400px; overflow-y:auto; padding:15px; background:#f8f9fa;"></div>
  
          <div class="d-flex p-2 border-top">
            <input type="text" id="chatInput" class="form-control me-2" placeholder="Ask anything..." />
            <button class="btn btn-primary" onclick="sendMessage()">Send</button>
          </div>
  
        </div>
      </div>
    </div>
  </div>
  
  
  <script>
  async function sendMessage() {
  
    const input = document.getElementById("chatInput");
    const chatArea = document.getElementById("chatArea");
  
    const question = input.value.trim();
    if (!question) return;
  
    // USER MESSAGE
    const userDiv = document.createElement("div");
    userDiv.className = "message user-msg";
    userDiv.innerText = question;
    chatArea.appendChild(userDiv);
  
    input.value = "";
    chatArea.scrollTop = chatArea.scrollHeight;
  
    // LOADING MESSAGE
    const typingDiv = document.createElement("div");
    typingDiv.className = "message bot-msg";
    typingDiv.innerHTML = `
      <span class="spinner-border spinner-border-sm me-2"></span>
      Thinking...
    `;
    chatArea.appendChild(typingDiv);
    chatArea.scrollTop = chatArea.scrollHeight;
  
    try {
  
      const response = await fetch("/bot/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question: question })
      });
  
      const data = await response.json();
      chatArea.removeChild(typingDiv);
  
      // üî• MODEL NOTICE
      const modelNotice = document.createElement("div");
      modelNotice.className = "message bot-msg model-upgrade";
      modelNotice.innerHTML = `
        ‚öôÔ∏è You are using lower Ollama model.<br>
        üöÄ Upgrade to work faster and smarter.(RAM minimum 16GB)
      `;
      chatArea.appendChild(modelNotice);
  
      // BOT RESPONSE CONTAINER
      const botDiv = document.createElement("div");
      botDiv.className = "message bot-msg";
      chatArea.appendChild(botDiv);
  
      // 1Ô∏è‚É£ STRING RESPONSE
      if (data.response) {
        typeMessage(botDiv, data.response);
      }
  
      // 2Ô∏è‚É£ TABLE RESPONSE
      else if (data.data && Array.isArray(data.data) && data.data.length > 0) {
  
        let table = "<div style='overflow-x:auto;'>";
        table += "<table class='table table-sm table-bordered table-striped'>";
        table += "<thead class='table-light'><tr>";
  
        Object.keys(data.data[0]).forEach(key => {
          table += `<th>${key}</th>`;
        });
  
        table += "</tr></thead><tbody>";
  
        data.data.forEach(row => {
          table += "<tr>";
          Object.values(row).forEach(val => {
            table += `<td>${val ?? ""}</td>`;
          });
          table += "</tr>";
        });
  
        table += "</tbody></table></div>";
  
        botDiv.innerHTML = table;
      }
  
      // 3Ô∏è‚É£ NO RECORDS
      else if (data.data && data.data.length === 0) {
        typeMessage(botDiv, "No records found.");
      }
  
      // 4Ô∏è‚É£ ERROR
      else if (data.error) {
        botDiv.innerHTML = `<span style="color:red;">Error: ${data.error}</span>`;
      }
  
      else {
        typeMessage(botDiv, "Sorry, I couldn't understand that.");
      }
  
      chatArea.scrollTop = chatArea.scrollHeight;
  
    } catch (error) {
      console.error(error);
    }
  }
  
  
  // TYPEWRITER EFFECT
  function typeMessage(element, text, speed = 15) {
    let i = 0;
    element.innerHTML = "";
    function typing() {
      if (i < text.length) {
        element.innerHTML += text.charAt(i);
        i++;
        setTimeout(typing, speed);
      }
    }
    typing();
  }
  
  
  // ENTER KEY SUPPORT
  document.getElementById("chatInput").addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
      e.preventDefault();
      sendMessage();
    }
  });
  
  
  // AUTO GREETING ON MODAL OPEN
  let hasGreeted = false;
  const aiModal = document.getElementById('AIMODAL');
  
  aiModal.addEventListener('shown.bs.modal', function () {
  
    if (hasGreeted) return;
  
    const chatArea = document.getElementById("chatArea");
  
    const botDiv = document.createElement("div");
    botDiv.className = "message bot-msg";
  
    chatArea.appendChild(botDiv);
  
    typeMessage(botDiv, "üëã Welcome! I‚Äôm here to help you with UMS queries.");
  
    chatArea.scrollTop = chatArea.scrollHeight;
  
    hasGreeted = true;
  });
  </script>
  