<style>
  .message {
    margin-bottom: 8px;
    padding: 8px 12px;
    border-radius: 14px;
    max-width: 75%;
    font-size: 14px;
    line-height: 1.5;
    word-wrap: break-word;
    animation: fadeIn 0.2s ease-in-out;
  }

  .user-msg {
    background: linear-gradient(135deg, #0d6efd, #2d8cff);
    color: white;
    margin-left: auto;
    text-align: right;
  }

  .bot-msg {
    background: #ffffff;
    border: 1px solid #e0e0e0;
    margin-right: auto;
    color: #212529;
  }

  .error-msg {
    color: #dc3545;
  }

  #chatArea {
    scroll-behavior: smooth;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to   { opacity: 1; transform: translateY(0); }
  }
</style>


<!-- AI MODAL -->
<div class="modal fade" id="AIMODAL" tabindex="-1" aria-labelledby="AIModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="AIModalLabel">ğŸ¤– UMS AI Assistant</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body p-0">

        <!-- CHAT AREA -->
        <div id="chatArea" style="height: 400px; overflow-y: auto; padding: 15px; background: #f8f9fa;"></div>

        <!-- INPUT AREA -->
        <div id="inputArea" class="d-flex align-items-center p-2 border-top gap-2">
          <input
            type="text"
            id="chatInput"
            class="form-control"
            placeholder="Ask anything..."
            autocomplete="off"
          />
          <button id="sendBtn" class="btn btn-primary px-3" onclick="sendMessage()">Send</button>
        </div>

      </div>
    </div>
  </div>
</div>


<script>
(function () {

  // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let hasGreeted = false;
  let currentAbortController = null;

  // â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const chatArea  = () => document.getElementById("chatArea");
  const chatInput = () => document.getElementById("chatInput");
  const sendBtn   = () => document.getElementById("sendBtn");
  const inputArea = () => document.getElementById("inputArea");

  // â”€â”€ Lock / Unlock input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function lockInput() {
    inputArea().style.opacity       = "0.6";
    inputArea().style.pointerEvents = "none";
    chatInput().disabled            = true;
    sendBtn().disabled              = true;
  }

  function unlockInput() {
    inputArea().style.opacity       = "1";
    inputArea().style.pointerEvents = "auto";
    chatInput().disabled            = false;
    sendBtn().disabled              = false;
    chatInput().focus();
  }

  // â”€â”€ Abort in-flight request â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function abortRequest() {
    if (currentAbortController) {
      currentAbortController.abort();
      currentAbortController = null;
    }
  }

  // â”€â”€ Append a plain text bubble â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function appendMessage(text, cssClass) {
    const div = document.createElement("div");
    div.className = `message ${cssClass}`;
    div.innerText = text;
    chatArea().appendChild(div);
    scrollToBottom();
    return div;
  }

  // â”€â”€ Append an empty bubble (for progressive fill) â”€â”€â”€
  function appendEmptyBubble(cssClass) {
    const div = document.createElement("div");
    div.className = `message ${cssClass}`;
    chatArea().appendChild(div);
    scrollToBottom();
    return div;
  }

  // â”€â”€ Typewriter effect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function typeMessage(element, text, speed = 15, onDone = null) {
    let i = 0;
    element.innerHTML = "";
    (function typing() {
      if (i < text.length) {
        element.innerHTML += text.charAt(i++);
        setTimeout(typing, speed);
      } else if (onDone) {
        onDone();
      }
    })();
  }

  // â”€â”€ Build HTML table from data array â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function buildTable(dataArr) {
    const wrapper = document.createElement("div");
    wrapper.style.overflowX = "auto";
    wrapper.style.marginTop = "8px";

    const keys = Object.keys(dataArr[0]);
    let html = "<table class='table table-sm table-bordered table-striped mb-0'>";
    html += "<thead class='table-light'><tr>" + keys.map(k => `<th>${k}</th>`).join("") + "</tr></thead>";
    html += "<tbody>";
    dataArr.forEach(row => {
      html += "<tr>" + keys.map(k => `<td>${row[k] ?? ""}</td>`).join("") + "</tr>";
    });
    html += "</tbody></table>";
    wrapper.innerHTML = html;
    return wrapper;
  }

  // â”€â”€ Scroll chat to bottom â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function scrollToBottom() {
    const el = chatArea();
    el.scrollTop = el.scrollHeight;
  }

  // â”€â”€ Send message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.sendMessage = async function () {
    const input    = chatInput();
    const question = input.value.trim();
    if (!question) return;

    // Show user bubble
    appendMessage(question, "user-msg");
    input.value = "";
    lockInput();

    // Thinking indicator
    const thinkingDiv = appendEmptyBubble("bot-msg");
    thinkingDiv.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Thinking...`;

    currentAbortController = new AbortController();

    try {
      const response = await fetch("/bot/ask", {
        method:  "POST",
        headers: { "Content-Type": "application/json" },
        body:    JSON.stringify({ question }),
        signal:  currentAbortController.signal
      });

      chatArea().removeChild(thinkingDiv);
      const data = await response.json();

      const botDiv = appendEmptyBubble("bot-msg");

      if (data.error) {
        // Error response
        botDiv.innerHTML = `<span class="error-msg">âš ï¸ ${data.error}</span>`;

      } else if (data.answer && data.data && data.data.length > 0) {
        // Answer + table
        const answerP = document.createElement("p");
        answerP.style.marginBottom = "0";
        botDiv.appendChild(answerP);
        typeMessage(answerP, data.answer, 15, () => {
          botDiv.appendChild(buildTable(data.data));
          scrollToBottom();
        });

      } else if (data.answer) {
        // Text-only answer (greetings, simple responses)
        typeMessage(botDiv, data.answer);

      } else if (data.data && data.data.length > 0) {
        // Table only (no answer text)
        botDiv.appendChild(buildTable(data.data));

      } else {
        botDiv.innerText = "Sorry, I couldn't find anything for that.";
      }

      scrollToBottom();

    } catch (err) {
      if (thinkingDiv.parentNode) chatArea().removeChild(thinkingDiv);
      const errDiv = appendEmptyBubble("bot-msg");
      errDiv.innerHTML = err.name === "AbortError"
        ? `<span style="color:#888;">â›” Request cancelled.</span>`
        : `<span class="error-msg">âš ï¸ Network error. Please try again.</span>`;
      currentAbortController = null;
    }

    unlockInput();
  };

  // â”€â”€ Enter key support â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById("chatInput").addEventListener("keydown", function (e) {
    if (e.key === "Enter" && !this.disabled) {
      e.preventDefault();
      sendMessage();
    }
  });

  // â”€â”€ Auto-greet on first modal open â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById("AIMODAL").addEventListener("shown.bs.modal", function () {
    if (hasGreeted) return;
    hasGreeted = true;
    const botDiv = appendEmptyBubble("bot-msg");
    typeMessage(botDiv, "ğŸ‘‹ Welcome! I'm here to help you with UMS queries.");
  });

})();
</script>