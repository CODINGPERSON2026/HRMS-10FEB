{% extends "baseView.html" %}
{% block content %}

<style>
<<<<<<< HEAD
    :root {
        --sidebar-width: 240px;
        --border: #e2e8f0;
        --card-gradient-start: #fdfbfb;
        --card-gradient-end: #ebedee;
    }
   
    .dashboard-container {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
    }
    .header-bar {
        background: #0d6efd;
        color: white;
        padding: 1rem 2rem;
        border-radius: 12px 12px 0 0;
        margin-bottom: 0;
    }
    .controls-bar {
        background: white;
        padding: 1.5rem 2rem;
        border-radius: 0 0 12px 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    .projects-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 1.5rem;
        margin-top: 1rem;
    }
    .project-card {
        background: linear-gradient(145deg, var(--card-gradient-start), var(--card-gradient-end));
        border-radius: 12px;
        border: 1px solid var(--border);
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        cursor: pointer;
        transition: all 0.4s ease;
    }
    
    .project-card:hover .p-3 { color: #0d6efd; }
    .stage-text.flash {
        animation: flashStage 0.8s ease;
    }
    @keyframes flashStage {
        0% { background-color: #d1e7dd; }
        50% { background-color: #0d6efd; color: white; }
        100% { background-color: transparent; color: inherit; }
    }
    .empty-state {
        text-align: center;
        padding: 3rem;
        grid-column: 1 / -1;
    }
    .floating-add-btn {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: #0d6efd;
        color: white;
        border: none;
        font-size: 1.4rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        z-index: 1050;
    }
    .floating-add-btn:hover {
        transform: scale(1.1);
        background: #2563eb;
    }

    
</style>
<div class="wrapper">
    {% set header = "Project Management" %}
    {% set subscript = "Create tasks â†’ View tasks â†’ Update tasks â†’ Assign tasks" %}
    {% include 'navbar/navbar.html' %}
<!-- PROJECT DASHBOARD AS FULL PAGE -->
<div class="dashboard-container">
    <div class="header-bar">
        <h3 class="mb-0">Project Monitoring Dashboard</h3>
    </div>

    <div class="controls-bar d-flex align-items-end gap-3 flex-wrap">
        <div>
            <label class="fw-bold small text-muted">Select Head</label>
            <select class="form-select" id="headSelect">
                <option value="all">All Heads</option>
            </select>
        </div>
        <div>
            <label class="fw-bold small text-muted">Filter by Stage</label>
            <select class="form-select w-auto" id="stageSelect">
                <option value="all">All Stages</option>
                <option value="PPP">PPP</option>
                <option value="AON">AON</option>
                <option value="FBU">FBU</option>
                <option value="TOB & TEC">TOB & TEC</option>
                <option value="B BD">B BD</option>
                <option value="OCB RA">OCB RA</option>
                <option value="Placement Of SO">Placement Of SO</option>
                <option value="Store/Items Delivery">Store / Items Delivery</option>
                <option value="ATP">ATP</option>
                <option value="PRAC & CRAC">PRAC & CRAC</option>
                <option value="Payment">Payment</option>
                <option value="Completed">Completed</option>
            </select>
        </div>
        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addHeadModal">
            Add Head
        </button>
    </div>
<!-- Loader -->
<div id="dropdownLoader" class="text-center my-3" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <div class="small text-muted mt-2">Loading data...</div>
</div>

    <div class="empty-state" id="emptyState"></div>
    <div class="projects-grid" id="projectsGrid"></div>
</div>
</div>


<!-- ADD PROJECT MODAL (Kept as modal) -->
<div class="modal fade" id="addProjectModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable" style="max-width: 1200px;">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Add New Project</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addProjectForm" class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Head *</label>
                        <select class="form-select" id="addProjectHeadSelect" name="head" required>
                            <option value="">Select Head</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Project Name *</label>
                        <input class="form-control" name="project_name" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Current Stage *</label>
                        <select class="form-select" name="current_stage" required>
                            <option value="">Select Stage</option>
                            <option value="PPP">PPP</option>
                            <option value="AON">AON</option>
                            <option value="FBU">FBU</option>
                            <option value="TOB & TEC">TOB & TEC</option>
                            <option value="B BD">B BD</option>
                            <option value="OCB RA">OCB RA</option>
                            <option value="Placement Of SO">Placement Of SO</option>
                            <option value="Store/Items Delivery">Store / Items Delivery</option>
                            <option value="ATP">ATP</option>
                            <option value="PRAC & CRAC">PRAC & CRAC</option>
                            <option value="Payment">Payment</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Project Cost (â‚¹) *</label>
                        <input class="form-control" name="project_cost" type="number" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Project Items *</label>
                        <input class="form-control" name="project_items" placeholder="e.g. Radios, Vehicles" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Quantity *</label>
                        <input class="form-control" name="quantity" type="number" min="1" required>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="project_description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" onclick="addProject()">Save Project</button>
            </div>
        </div>
    </div>
</div>

<!-- Project Details Modal -->
<div class="modal fade" id="projectDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="detailProjectName">Project Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table class="table table-bordered">
                    <tbody>
                        <tr><th style="width: 25%;">Head</th><td id="detailHead"></td></tr>
                        <tr><th>Stage</th><td id="detailStage"></td></tr>
                        <tr><th>Cost</th><td>â‚¹<span id="detailCost"></span></td></tr>
                        <tr><th>Items</th><td id="detailItems"></td></tr>
                        <tr><th>Quantity</th><td id="detailQuantity"></td></tr>
                        <tr><th>Description</th><td id="detailDescription"></td></tr>
                    </tbody>
                </table>
                <div class="mt-3">
                    <label class="fw-bold">Update Stage:</label>
                    <select class="form-select w-auto" id="modalStageSelect" onchange="updateStage(this.value)">
                        <option value="PPP">PPP</option>
                        <option value="AON">AON</option>
                        <option value="FBU">FBU</option>
                        <option value="TOB & TEC">TOB & TEC</option>
                        <option value="B BD">B BD</option>
                        <option value="OCB RA">OCB RA</option>
                        <option value="Placement Of SO">Placement Of SO</option>
                        <option value="Store/Items Delivery">Store / Items Delivery</option>
                        <option value="ATP">ATP</option>
                        <option value="PRAC & CRAC">PRAC & CRAC</option>
                        <option value="Payment">Payment</option>
                        <option value="Completed">Completed</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Head Modal -->
<div class="modal fade" id="addHeadModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Add New Head</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addHeadForm">
                    <div class="mb-3">
                        <label class="form-label">Head Name</label>
                        <input type="text" class="form-control" id="headNameInput" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Add Head</button>
                </form>
                <div id="headAlert" class="mt-2"></div>
            </div>
        </div>
    </div>
</div>

<button class="floating-add-btn" data-bs-toggle="modal" data-bs-target="#addProjectModal">
    <i class="fas fa-plus"></i>
</button>

<script>
    let currentProjectId = null;
    let allProjects = [];

    async function loadHeads() {
        const selects = [document.getElementById("headSelect"), document.getElementById("addProjectHeadSelect")];
        selects.forEach(s => s.disabled = true);

        try {
            const res = await fetch('/get_project_heads');
            const heads = await res.json();

            selects.forEach(select => {
                if (select.id === "headSelect") {
                    select.innerHTML = '<option value="all">All Heads</option>';
                } else {
                    select.innerHTML = '<option value="">Select Head</option>';
                }
                heads.forEach(h => select.add(new Option(h.head_name, h.head_name)));
                select.disabled = false;
            });
        } catch (err) {
            console.error(err);
        }
    }

    async function loadProjects() {
        try {
            const res = await fetch('/api/get_projects');
            allProjects = await res.json();
            renderProjects();
        } catch (err) {
            document.getElementById("projectsGrid").innerHTML = "<p class='text-danger text-center'>Failed to load projects.</p>";
        }
    }

    function renderProjects() {
        const grid = document.getElementById("projectsGrid");
        grid.innerHTML = "";
        allProjects.forEach(p => {
            const card = document.createElement("div");
            card.className = "project-card";
            card.dataset.id = p.project_id;
            card.dataset.head = (p.head || "Uncategorized").trim();
            card.dataset.stage = p.current_stage;
            card.dataset.name = p.project_name;
            card.dataset.cost = p.project_cost;
            card.dataset.items = p.project_items;
            card.dataset.quantity = p.quantity;
            card.dataset.description = p.project_description || "";
            card.onclick = () => showProjectDetails(card);

            card.innerHTML = `
                <div class="p-3 border-bottom fw-bold">${p.project_name}</div>
                <div class="p-3">
                    <div><strong>Head:</strong> ${card.dataset.head}</div>
                    <div>Stage: <span class="stage-text">${p.current_stage}</span></div>
                    <div>Cost: â‚¹${p.project_cost}</div>
                    <div>Items: ${p.project_items}</div>
                    <div>Qty: ${p.quantity}</div>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    function applyFilters() {
        const selectedHead = document.getElementById("headSelect").value;
        const selectedStage = document.getElementById("stageSelect").value;
        const cards = document.querySelectorAll(".project-card");
        const emptyState = document.getElementById("emptyState");

        if (selectedHead === "all") {
            const headCounts = {};
            
            cards.forEach(card => {
                let head = card.dataset.head || "Uncategorized";
                
                headCounts[head] = (headCounts[head] || 0) + 1;
            });

            emptyState.style.display = "grid";
            emptyState.style.gridTemplateColumns = "repeat(auto-fill, minmax(180px, 1fr))";
            emptyState.style.gap = "1rem";
            emptyState.innerHTML = "";

            if (Object.keys(headCounts).length === 0) {
                emptyState.innerHTML = '<div class="text-center w-100"><i class="fas fa-folder-open fa-3x mb-3 text-muted"></i><h5>No projects available</h5></div>';
            } else {
                for (const [head, count] of Object.entries(headCounts)) {
                    const summary = document.createElement("div");
                    summary.className = "project-card text-center";
                    summary.style.cursor = "default";
                    summary.innerHTML = `<div class="p-3 fw-bold fs-5">${head}</div><div class="p-3">${count} Project${count > 1 ? "s" : ""}</div>`;
                    emptyState.appendChild(summary);
                }
            }
            cards.forEach(c => c.style.display = "none");
        } else {
            let visible = 0;
            cards.forEach(card => {
                const matchHead = card.dataset.head === selectedHead;
                const matchStage = selectedStage === "all" || card.dataset.stage === selectedStage;
                card.style.display = matchHead && matchStage ? "block" : "none";
                if (matchHead && matchStage) visible++;
            });

            emptyState.style.display = visible === 0 ? "block" : "none";
            if (visible === 0) {
                emptyState.innerHTML = '<div class="text-center"><i class="fas fa-search fa-3x mb-3 text-muted"></i><h5>No projects found</h5></div>';
            }
        }
    }

    // Load data on page load
   

    document.getElementById("headSelect").addEventListener("change", applyFilters);
    document.getElementById("stageSelect").addEventListener("change", applyFilters);

    function showProjectDetails(card) {
        if (document.getElementById("headSelect").value === "all") {
            alert("Please select a specific Head to view project details.");
            return;
        }
        currentProjectId = card.dataset.id;
        document.getElementById("detailProjectName").textContent = card.dataset.name;
        document.getElementById("detailHead").textContent = card.dataset.head;
        document.getElementById("detailStage").textContent = card.dataset.stage;
        document.getElementById("detailCost").textContent = card.dataset.cost;
        document.getElementById("detailItems").textContent = card.dataset.items;
        document.getElementById("detailQuantity").textContent = card.dataset.quantity;
        document.getElementById("detailDescription").textContent = card.dataset.description || "No description";
        document.getElementById("modalStageSelect").value = card.dataset.stage;

        new bootstrap.Modal(document.getElementById("projectDetailModal")).show();
    }

    function updateStage(stage) {
        if (!currentProjectId) return;

        fetch('/update_project_stage', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ project_id: currentProjectId, new_stage: stage })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                document.getElementById("detailStage").textContent = stage;
                const card = document.querySelector(`.project-card[data-id="${currentProjectId}"]`);
                if (card) {
                    card.dataset.stage = stage;
                    card.querySelector(".stage-text").textContent = stage;
                    card.querySelector(".stage-text").classList.add("flash");
                    setTimeout(() => card.querySelector(".stage-text").classList.remove("flash"), 800);
                }
                applyFilters();
            }
        });
    }

    function addProject() {
        const form = document.getElementById("addProjectForm");
        const formData = new FormData(form);

        fetch("/add_project", {
            method: "POST",
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === "success") {
                bootstrap.Modal.getInstance(document.getElementById("addProjectModal")).hide();
                form.reset();
                showLoader();
                loadProjects().then(hideLoader);
                loadHeads();
            } else {
                alert("Failed: " + (data.message || "Unknown error"));
            }
        })
        .catch(() => alert("Server error"));
    }

    document.getElementById("addHeadForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const headName = document.getElementById("headNameInput").value.trim();
        if (!headName) return;

        fetch('/add_head', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ head_name: headName })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                document.getElementById("headNameInput").value = '';
                bootstrap.Modal.getInstance(document.getElementById("addHeadModal")).hide();
                loadHeads();
                showLoader();
loadHeads().then(hideLoader);
            }
        });
    });


    function showLoader() {
    document.getElementById("dropdownLoader").style.display = "block";
}

function hideLoader() {
    document.getElementById("dropdownLoader").style.display = "none";
}

</script>
<script>

document.addEventListener("DOMContentLoaded", () => {
    showLoader();

    Promise.all([loadHeads(), loadProjects()])
        .then(() => {
            document.getElementById("headSelect").value = "all";
            applyFilters();
        })
        .finally(() => {
            hideLoader();
        });
});

</script>
{% endblock %}





=======


    .prj-dashboard-container {
        padding: 0;
      }
    
      .prj-header-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        border-radius: 8px 8px 0 0;
      }
    
      .prj-header-wrapper h5 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
      }
    
      .prj-stats-display {
        display: flex;
        gap: 20px;
      }
    
      .prj-stat-box {
        text-align: center;
      }
    
      .prj-stat-number {
        font-size: 1.5rem;
        font-weight: 700;
      }
    
      .prj-stat-label {
        font-size: 0.75rem;
        opacity: 0.9;
        text-transform: uppercase;
      }
    
      .prj-filters-bar {
        display: flex;
        gap: 12px;
        padding: 20px;
        background: rgba(0, 0, 0, 0.02);
        flex-wrap: wrap;
        align-items: center;
      }
    
      .prj-filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }
    
      .prj-filter-dropdown {
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.9rem;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
      }
    
      .prj-filter-dropdown:focus {
        outline: none;
        border-color: var(--primary-color);
      }
    
      .prj-search-wrapper {
        flex: 1;
        min-width: 250px;
        position: relative;
      }
    
      .prj-search-field {
        width: 100%;
        padding: 8px 12px 8px 36px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.9rem;
        transition: all 0.3s ease;
      }
    
      .prj-search-field:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.1);
      }
    
      .prj-search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
      }
    
      .prj-cards-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
          gap: 24px;
          padding: 20px;
          max-height: 60vh;
          overflow-y: auto;
        }
        
    
      .prj-single-card {
        background: var(--card-background);
        border-radius: 16px;
        padding: 24px;
        border: 1px solid var(--border-color);
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }
    
      .prj-single-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        transform: scaleX(0);
        transform-origin: left;
        transition: transform 0.3s ease;
      }
    
      .prj-single-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        border-color: var(--primary-color);
      }
    
      .prj-single-card:hover::before {
        transform: scaleX(1);
      }
    
      .prj-card-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
      }
    
      .prj-card-heading {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
        line-height: 1.3;
        max-width: 75%;
      }
    
      .prj-card-badge {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        white-space: nowrap;
      }
    
      .prj-card-desc {
        color: var(--text-secondary);
        font-size: 0.9rem;
        line-height: 1.6;
        margin-bottom: 16px;
        display: -webkit-box;
        
        -webkit-box-orient: vertical;
        overflow: hidden;
        min-height: 60px;
      }
    
      .prj-card-info {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 16px;
      }
    
      .prj-info-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.85rem;
        color: var(--text-secondary);
      }
    
      .prj-info-item i {
        color: var(--primary-color);
        font-size: 1rem;
      }
    
      .prj-info-cost {
        font-weight: 600;
        color: #388e3c;
      }
    
      .prj-stage-badge {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 12px;
      }
    
      /* Stage Colors */
      .prj-stage-ppp {
        background: #e3f2fd;
        color: #1976d2;
      }
    
      .prj-stage-aon {
        background: #f3e5f5;
        color: #7b1fa2;
      }
    
      .prj-stage-fbu {
        background: #fff3e0;
        color: #f57c00;
      }
    
      .prj-stage-tob_tec,
      .prj-stage-tob-tec {
        background: #e8f5e9;
        color: #388e3c;
      }
    
      .prj-stage-b_bd,
      .prj-stage-b-bd {
        background: #fce4ec;
        color: #c2185b;
      }
    
      .prj-stage-ocb_ra,
      .prj-stage-ocb-ra {
        background: #e0f2f1;
        color: #00796b;
      }
    
      .prj-stage-placement_of_so,
      .prj-stage-placement-of-so {
        background: #fff9c4;
        color: #f57f17;
      }
    
      .prj-stage-store_items_delivery,
      .prj-stage-store-items-delivery,
      .prj-stage-store-delivery {
        background: #ede7f6;
        color: #5e35b1;
      }
    
      .prj-stage-atp {
        background: #e1f5fe;
        color: #0277bd;
      }
    
      .prj-stage-prac_crac,
      .prj-stage-prac-crac {
        background: #f1f8e9;
        color: #558b2f;
      }
    
      .prj-stage-payment {
        background: #fff8e1;
        color: #ff6f00;
      }
    
      .prj-stage-completed {
        background: #e8f5e9;
        color: #2e7d32;
      }
    
      .prj-card-bottom {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border-color);
      }
    
      .prj-owner-info {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.85rem;
        color: var(--text-secondary);
      }
    
      .prj-owner-circle {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.85rem;
      }
    
      .prj-items-badge {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.8rem;
        padding: 4px 10px;
        border-radius: 12px;
        background: rgba(25, 118, 210, 0.1);
        color: #1976d2;
        font-weight: 600;
      }
    
      /* Empty State */
      .prj-empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
        grid-column: 1 / -1;
      }
    
      .prj-empty-state i {
        font-size: 4rem;
        color: var(--border-color);
        margin-bottom: 20px;
      }
    
      .prj-empty-state h4 {
        color: var(--text-primary);
        margin-bottom: 10px;
      }
    
      /* Loading Skeleton */
      .prj-skeleton-card {
        background: var(--card-background);
        border-radius: 16px;
        padding: 24px;
        border: 1px solid var(--border-color);
      }
    
      .prj-skeleton-line {
        background: linear-gradient(90deg, var(--border-color) 25%, var(--text-secondary) 50%, var(--border-color) 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: 4px;
        margin-bottom: 12px;
      }
    
      /* ==================== PROJECT DETAILS MODAL ==================== */
      .prj-detail-modal .modal-dialog {
        max-width: 900px;
      }
    
      .prj-detail-header {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        padding: 30px;
        border-radius: 16px 16px 0 0;
        margin: -1rem -1rem 0 -1rem;
      }
    
      .prj-detail-title {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 12px;
      }
    
      .prj-detail-meta-row {
        display: flex;
        gap: 24px;
        flex-wrap: wrap;
        margin-top: 16px;
        opacity: 0.95;
      }
    
      .prj-meta-detail {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
      }
    
      .prj-detail-body-content {
        padding: 30px;
      }
    
      .prj-detail-section {
        margin-bottom: 30px;
      }
    
      .prj-section-heading {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
    
      .prj-section-heading i {
        color: var(--primary-color);
      }
    
      .prj-section-text {
        color: var(--text-secondary);
        line-height: 1.8;
        padding: 16px;
        background: rgba(0, 0, 0, 0.02);
        border-radius: 8px;
        border-left: 3px solid var(--primary-color);
      }
    
      .prj-detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
      }
    
      .prj-grid-item {
        padding: 12px;
        background: rgba(0, 0, 0, 0.02);
        border-radius: 8px;
      }
    
      .prj-grid-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        margin-bottom: 4px;
      }
    
      .prj-grid-value {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
      }
    
      /* Stage Update Form */
      .prj-update-form {
        background: var(--card-background);
        padding: 20px;
        border-radius: 12px;
        border: 2px dashed var(--border-color);
      }
    
      .prj-select-box {
        position: relative;
        margin-bottom: 16px;
      }
    
      .prj-stage-dropdown {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
      }
    
      .prj-stage-dropdown:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.1);
      }
    
      .prj-notes-textarea {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.95rem;
        resize: vertical;
        min-height: 100px;
        transition: all 0.3s ease;
      }
    
      .prj-notes-textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.1);
      }
    
      .prj-update-button {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 16px;
      }
    
      .prj-update-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }
    
      .prj-update-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
    
      /* Responsive */
      @media (max-width: 768px) {
        .prj-cards-grid {
          grid-template-columns: 1fr;
          gap: 16px;
          padding: 12px;
        }
    
        .prj-filters-bar {
          flex-direction: column;
          align-items: stretch;
        }
    
        .prj-search-wrapper {
          width: 100%;
        }
    
        .prj-single-card {
          padding: 20px;
        }
    
        .prj-card-heading {
          font-size: 1.1rem;
          max-width: 65%;
        }
    
        .prj-detail-header {
          padding: 20px;
        }
    
        .prj-detail-title {
          font-size: 1.4rem;
        }
    
        .prj-detail-meta-row {
          gap: 12px;
        }
    
        .prj-detail-body-content {
          padding: 20px;
        }
    
        .prj-detail-grid {
          grid-template-columns: 1fr;
        }
      }
</style>

{% set header = "Project Management" %}
{% set subscript = "Create Projects â†’ View Projects â†’ Update Projects" %}
{% include 'navbar/navbar.html' %}
<div class="container-fluid py-5">
  <div class="card shadow border-0">

    <!-- HEADER -->
    <div class="prj-header-wrapper">
      <div class="d-flex align-items-center gap-3">
        <h5 class="mb-0">
          <i class="fas fa-rocket me-2"></i>Projects
        </h5>

        <button class="btn btn-light btn-sm fw-semibold"
                onclick="openCreateProjectModal()">
          <i class="fas fa-plus me-1"></i> New Project
        </button>
      </div>

      <div class="prj-stats-display">
        <div class="prj-stat-box">
          <div class="prj-stat-number" id="prjTotalCount">0</div>
          <div class="prj-stat-label">Total</div>
        </div>
        <div class="prj-stat-box">
          <div class="prj-stat-number" id="prjActiveCount">0</div>
          <div class="prj-stat-label">Active</div>
        </div>
        <div class="prj-stat-box">
          <div class="prj-stat-number" id="prjCompletedCount">0</div>
          <div class="prj-stat-label">Completed</div>
        </div>
      </div>
    </div>

    <!-- FILTERS -->
    <div class="prj-filters-bar">

      <div class="prj-filter-group">
        <label class="fw-semibold">Stage:</label>
        <select class="prj-filter-dropdown" id="prjStageFilter" onchange="filterProjectsData()">
          <option value="">All Stages</option>
          <option value="PPP">PPP</option>
          <option value="AON">AON</option>
          <option value="FBU">FBU</option>
          <option value="TOB & TEC">TOB & TEC</option>
          <option value="B BD">B BD</option>
          <option value="OCB RA">OCB RA</option>
          <option value="Placement Of SO">Placement Of SO</option>
          <option value="Store/Items Delivery">Store / Items Delivery</option>
          <option value="ATP">ATP</option>
          <option value="PRAC & CRAC">PRAC & CRAC</option>
          <option value="Payment">Payment</option>
          <option value="Completed">Completed</option>
        </select>
      </div>

      <div class="prj-filter-group">
        <label class="fw-semibold">Head:</label>
        <select class="prj-filter-dropdown" id="prjHeadFilter" onchange="filterProjectsData()">
          <option value="">All Heads</option>
        </select>
      </div>

      <div class="prj-search-wrapper">
        <i class="fas fa-search prj-search-icon"></i>
        <input type="text"
               class="prj-search-field"
               id="prjSearchInput"
               placeholder="Search projects..."
               onkeyup="filterProjectsData()" />
      </div>

    </div>

    <!-- PROJECT GRID -->
    <div class="prj-dashboard-container">
      <div class="prj-cards-grid" id="prjCardsGrid"></div>
    </div>

  </div>
</div>



<!-- ================= PROJECT DETAILS MODAL ================= -->
<div class="modal fade prj-detail-modal" id="prjDetailsModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header border-0 p-0">
        <div class="prj-detail-header w-100">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h3 class="prj-detail-title" id="prjDetailTitle"></h3>
              <span class="badge bg-white text-dark" id="prjDetailBadge"></span>
            </div>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="prj-detail-meta-row" id="prjDetailMeta"></div>
        </div>
      </div>

      <div class="modal-body prj-detail-body-content">

        <div class="prj-detail-section">
          <h5 class="prj-section-heading">
            <i class="fas fa-align-left"></i>
            Project Description
          </h5>
          <div class="prj-section-text" id="prjDetailDescription"></div>
        </div>

        <div class="prj-detail-section">
          <h5 class="prj-section-heading">
            <i class="fas fa-info-circle"></i>
            Project Details
          </h5>
          <div class="prj-detail-grid">
            <div class="prj-grid-item">
              <div class="prj-grid-label">Cost</div>
              <div class="prj-grid-value" id="prjDetailCost"></div>
            </div>
            <div class="prj-grid-item">
              <div class="prj-grid-label">Items</div>
              <div class="prj-grid-value" id="prjDetailItems"></div>
            </div>
            <div class="prj-grid-item">
              <div class="prj-grid-label">Quantity</div>
              <div class="prj-grid-value" id="prjDetailQuantity"></div>
            </div>
          </div>
        </div>

        <div class="prj-detail-section">
          <h5 class="prj-section-heading">
            <i class="fas fa-tasks"></i>
            Current Status
          </h5>
          <div id="prjDetailCurrentStage"></div>
        </div>
        <div class="prj-detail-section">
            <h5 class="prj-section-heading">
              <i class="fas fa-edit"></i>
              Update Stage
            </h5>
          
            <div class="prj-update-form">
              <select class="prj-stage-dropdown" id="prjStageUpdate">
                <option value="PPP">PPP</option>
                <option value="AON">AON</option>
                <option value="Completed">Completed</option>
              </select>
          
              <textarea class="prj-notes-textarea"
                        id="prjUpdateNotes"
                        placeholder="Add remarks..."></textarea>
          
              <button class="prj-update-button"
                      onclick="updateProjectStage()">
                Update Stage
              </button>
            </div>
          </div>
          

      </div>
    </div>
  </div>
</div>



{% include 'modals/add_new_project/modal.html' %}



<script>
let allProjectsData = [];
let filteredProjectsData = [];
let selectedProjectData = null;


document.addEventListener('DOMContentLoaded', function () {
  loadAllProjectsData();
  loadProjectHeadsData();
});


async function loadProjectHeadsData() {
  const response = await fetch('/get_project_heads');
  const heads = await response.json();
  const headFilter = document.getElementById('prjHeadFilter');
  headFilter.innerHTML = '<option value="">All Heads</option>';

  heads.forEach(head => {
    const option = document.createElement('option');
    option.value = head.head_name;
    option.textContent = head.head_name;
    headFilter.appendChild(option);
  });
}


async function loadAllProjectsData() {
  const response = await fetch('/projects/all_projects');
  const data = await response.json();

  allProjectsData = data.projects || [];
  filteredProjectsData = [...allProjectsData];

  updateProjectStatsData();
  renderProjectsData(filteredProjectsData);
}


function renderProjectsData(projects) {
    const grid = document.getElementById('prjCardsGrid');
  
    if (projects.length === 0) {
      grid.innerHTML = `
        <div class="prj-empty-state">
          <i class="fas fa-folder-open"></i>
          <h4>No Projects Found</h4>
          <p>Try changing filters or create a new project.</p>
        </div>
      `;
      return;
    }
  
    grid.innerHTML = projects.map(project => {
  
      const stageClass = getStageClass(project.stage);
  
      return `
        <div class="prj-single-card" onclick="openProjectDetailsView(${project.id})">
  
          <div class="prj-card-top">
            <h3 class="prj-card-heading">${project.title || 'Untitled Project'}</h3>
            <span class="prj-stage-badge ${stageClass}">
              ${project.stage || 'N/A'}
            </span>
          </div>
  
          <p class="prj-card-desc">
            ${project.description || 'No description available'}
          </p>
  
          <div class="prj-card-info">
            <div class="prj-info-item">
              <i class="fas fa-coins"></i>
              <span class="prj-info-cost">
                ${formatProjectCurrency(project.cost)}
              </span>
            </div>
  
            <div class="prj-info-item">
              <i class="fas fa-box"></i>
              ${project.items || 0} Items
            </div>
          </div>
  
          <div class="prj-card-bottom">
            <div class="prj-owner-info">
              <div class="prj-owner-circle">
                ${(project.owner || 'U').charAt(0).toUpperCase()}
              </div>
              ${project.owner || 'Unassigned'}
            </div>
  
            <div class="prj-items-badge">
              <i class="fas fa-layer-group"></i>
              Qty: ${project.quantity || 0}
            </div>
          </div>
  
        </div>
      `;
    }).join('');
  }
  function getStageClass(stage) {
    if (!stage) return '';
  
    return 'prj-stage-' + stage
      .toLowerCase()
      .replace(/&/g, '')
      .replace(/\//g, '')
      .replace(/\s+/g, '_');
  }
    


  function openProjectDetailsView(projectId) {
    selectedProjectData = allProjectsData.find(p => p.id === projectId);
    if (!selectedProjectData) return;
  
    document.getElementById('prjDetailTitle').textContent =
      selectedProjectData.title;
  
    document.getElementById('prjDetailBadge').textContent =
      `PRJ-${selectedProjectData.id}`;
  
    document.getElementById('prjDetailDescription').textContent =
      selectedProjectData.description || 'No description available';
  
    document.getElementById('prjDetailCost').textContent =
      formatProjectCurrency(selectedProjectData.cost);
  
    document.getElementById('prjDetailItems').textContent =
      selectedProjectData.items || '-';
  
    document.getElementById('prjDetailQuantity').textContent =
      selectedProjectData.quantity || 0;
  
    // ðŸ”¹ META INFO
    document.getElementById('prjDetailMeta').innerHTML = `
      <div class="prj-meta-detail">
        <i class="fas fa-user"></i>
        ${selectedProjectData.owner || 'Unassigned'}
      </div>
      <div class="prj-meta-detail">
        <i class="fas fa-calendar"></i>
        ${selectedProjectData.created_at || 'N/A'}
      </div>
    `;
  
    // ðŸ”¹ CURRENT STAGE
    document.getElementById('prjDetailCurrentStage').innerHTML = `
      <span class="prj-stage-badge ${getStageClass(selectedProjectData.stage)}">
        ${selectedProjectData.stage || 'N/A'}
      </span>
    `;
  
    new bootstrap.Modal(
      document.getElementById('prjDetailsModal')
    ).show();
  }
  


function filterProjectsData() {
  const stage = document.getElementById('prjStageFilter').value.toLowerCase();
  const head = document.getElementById('prjHeadFilter').value.toLowerCase();
  const search = document.getElementById('prjSearchInput').value.toLowerCase();

  filteredProjectsData = allProjectsData.filter(p =>
    (!stage || (p.stage || '').toLowerCase() === stage) &&
    (!head || (p.owner || '').toLowerCase() === head) &&
    (!search ||
      (p.title || '').toLowerCase().includes(search) ||
      (p.description || '').toLowerCase().includes(search))
  );

  renderProjectsData(filteredProjectsData);
  updateProjectStatsData();
}


function updateProjectStatsData() {
  const total = allProjectsData.length;
  const completed = allProjectsData.filter(p => (p.stage || '').toLowerCase() === 'completed').length;
  const active = total - completed;

  document.getElementById('prjTotalCount').textContent = total;
  document.getElementById('prjActiveCount').textContent = active;
  document.getElementById('prjCompletedCount').textContent = completed;
}


function formatProjectCurrency(amount) {
  const num = parseFloat(amount);
  if (isNaN(num)) return 'â‚¹ 0';
  return 'â‚¹ ' + num.toLocaleString('en-IN');
}


async function updateProjectStage() {
    if (!selectedProjectData) return;
  
    const newStage = document.getElementById('prjStageUpdate').value;
    const notes = document.getElementById('prjUpdateNotes').value;
  
    await fetch(`/projects/update_stage/${selectedProjectData.id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        stage: newStage,
        notes: notes
      })
    });
  
    loadAllProjectsData();
  }
  
</script>

{% endblock %}
>>>>>>> ef482ff93d52ef510d0ea255d803835abe503386
